<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>대화</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="chat-page">
    <header class="topbar">
      <div class="topbar-title">대화</div>
      <nav class="topbar-actions">
        <div class="nav-tabs">
          <a class="tab" href="{{ url_for('diary') }}">일기</a>
          <a class="tab is-active" href="{{ url_for('index', view='chat', q=search_query) }}">대화</a>
          <a class="tab" href="{{ url_for('todo') }}">함께할일</a>
          <a class="tab" href="{{ url_for('memories') }}">추억</a>
        </div>
        <div class="nav-links">
          <a class="link" href="{{ url_for('index', view='txt', q=search_query) }}">텍스트 형식</a>
          <a class="link" href="{{ url_for('admin_import') }}">가져오기</a>
          <a class="link" href="{{ url_for('admin_export') }}">내보내기</a>
          <a class="link" href="{{ url_for('logout') }}">로그아웃</a>
        </div>
      </nav>
      <div class="topbar-tools">
        <form class="search-form" method="get" action="{{ url_for('index') }}">
          <input type="hidden" name="view" value="chat" />
          <input class="search" type="search" name="q" placeholder="검색어" value="{{ search_query or '' }}" />
          <button class="btn btn-secondary" type="submit">검색</button>
          {% if search_query %}
            <a class="link" href="{{ url_for('index', view='chat') }}">전체</a>
          {% endif %}
        </form>
        <form class="me-form" method="post" action="{{ url_for('set_me') }}">
          <label class="me-label">오른쪽(나)</label>
          <select class="select" name="me_name" onchange="this.form.submit()">
            <option value="">(선택)</option>
            {% for s in senders or [] %}
              <option value="{{ s.sender }}" {% if me_name == s.sender %}selected{% endif %}>{{ s.sender }} ({{ s.count }})</option>
            {% endfor %}
          </select>
        </form>
        <form class="jump-date-form" method="get" action="{{ url_for('index') }}">
          <input type="hidden" name="view" value="chat" />
          <input type="hidden" name="q" value="{{ search_query or '' }}" />
          <label class="me-label" for="focus-date-input">날짜 이동</label>
          <input class="input jump-date-input" id="focus-date-input" type="date" name="date" value="{{ focus_date or '' }}" />
          <button class="btn btn-secondary" type="submit">이동</button>
        </form>
      </div>
    </header>

    {% with flashes = get_flashed_messages(with_categories=true) %}
      {% if flashes %}
        <div class="flash chat-flash">
          {% for category, message in flashes %}
            <div class="flash-item {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if search_query %}
      <div class="search-banner">“{{ search_query }}” 검색 결과: {{ search_count or 0 }}건</div>
    {% endif %}

    <section class="chat-bookmark-panel">
      <div class="chat-bookmark-toolbar">
        <form id="bookmark-save-form" class="chat-bookmark-save-form" method="post" action="{{ url_for('chat_bookmark_add') }}">
          <input type="hidden" name="view" value="chat" />
          <input type="hidden" name="q" value="{{ search_query or '' }}" />
          <input type="hidden" name="date" value="{{ focus_date or '' }}" />
          <input type="hidden" name="message_id" id="bookmark-message-id" />
          <input type="hidden" name="start_message_id" id="bookmark-start" />
          <input type="hidden" name="end_message_id" id="bookmark-end" />
          <input class="input chat-bookmark-title" type="text" name="title" id="bookmark-title" placeholder="책갈피 이름 (선택)" />
          <button class="btn btn-secondary" type="button" id="bookmark-save-single">선택 1개 저장</button>
          <button class="btn btn-secondary" type="button" id="bookmark-save-range">선택 범위 저장</button>
          <button class="btn btn-secondary" type="button" id="bookmark-clear-selection">선택 해제</button>
        </form>
      </div>
      <div class="chat-bookmark-status" id="bookmark-status">
        메시지를 클릭해서 1개(단건) 또는 2개(범위) 선택
        {% if loaded_start_date and loaded_end_date %}
          · 현재 로딩 범위: {{ loaded_start_date }} ~ {{ loaded_end_date }}
        {% endif %}
      </div>
    </section>

    <div class="chat-main-wrap">
      <main class="chat" id="chat-scroll">
        {% for d in days or [] %}
          <div class="day-sep" id="day-{{ d.date_key }}">--------------- {{ d.date_ko }} ---------------</div>
          {% for m in d.messages %}
            {% set is_me = (me_name and m.sender == me_name) %}
            <div class="msg-row msg-selectable {{ 'me' if is_me else 'other' }}" id="msg-{{ m.id }}" data-msg-id="{{ m.id }}" data-msg-seq="{{ m.seq }}">
              {% if is_me %}
                <div class="time">{{ m.time_ko }}</div>
                <div class="bubble bubble-me">{{ m.text_html }}</div>
              {% else %}
                <div class="msg-col">
                  <div class="sender">{{ m.sender }}</div>
                  <div class="bubble bubble-other">{{ m.text_html }}</div>
                </div>
                <div class="time">{{ m.time_ko }}</div>
              {% endif %}
            </div>
          {% endfor %}
        {% endfor %}
      </main>

      <aside class="chat-sidebar">
        <div class="chat-sidebar-head">책갈피 {{ bookmarks|length }}개</div>
        {% if bookmarks %}
          <div class="chat-bookmark-list-vertical">
            {% for b in bookmarks %}
              <div class="chat-bookmark-item {% if bookmark_selected_id == b.id %}is-selected{% endif %}">
                <a class="chat-bookmark-link" href="{{ url_for('index', view='chat', q=search_query, bookmark=b.id) }}">{{ b.display_title }}</a>
                <div class="chat-bookmark-meta">{{ b.display_range }}</div>
                <form method="post" action="{{ url_for('chat_bookmark_delete', bookmark_id=b.id) }}">
                  <input type="hidden" name="view" value="chat" />
                  <input type="hidden" name="q" value="{{ search_query or '' }}" />
                  <input type="hidden" name="date" value="{{ focus_date or '' }}" />
                  <input type="hidden" name="bookmark" value="{{ bookmark_selected_id or '' }}" />
                  <button class="link-button" type="submit">삭제</button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="chat-bookmark-empty">저장된 책갈피가 없습니다.</div>
        {% endif %}
      </aside>
    </div>

    <script>
      (function () {
        var saveForm = document.getElementById("bookmark-save-form");
        var messageIdInput = document.getElementById("bookmark-message-id");
        var startInput = document.getElementById("bookmark-start");
        var endInput = document.getElementById("bookmark-end");
        var statusEl = document.getElementById("bookmark-status");
        var selectRows = Array.prototype.slice.call(document.querySelectorAll(".msg-selectable"));
        var selectedRows = [];

        function getMsgSeq(row) {
          return Number(row.getAttribute("data-msg-seq") || "0");
        }

        function getMsgId(row) {
          return String(row.getAttribute("data-msg-id") || "");
        }

        function updateSelectionUI() {
          selectRows.forEach(function (row) {
            row.classList.remove("msg-selected");
            row.classList.remove("msg-selected-end");
          });
          selectedRows.forEach(function (row, idx) {
            row.classList.add("msg-selected");
            if (idx === 1) row.classList.add("msg-selected-end");
          });

          if (!messageIdInput || !startInput || !endInput || !statusEl) return;
          messageIdInput.value = "";
          startInput.value = "";
          endInput.value = "";

          var prefix = "메시지를 클릭해서 1개(단건) 또는 2개(범위) 선택";
          if (selectedRows.length === 0) {
            statusEl.textContent = prefix;
            return;
          }
          if (selectedRows.length === 1) {
            messageIdInput.value = getMsgId(selectedRows[0]);
            statusEl.textContent = "단건 저장 준비: 메시지 " + messageIdInput.value;
            return;
          }

          var ordered = selectedRows.slice().sort(function (a, b) {
            return getMsgSeq(a) - getMsgSeq(b);
          });
          startInput.value = getMsgId(ordered[0]);
          endInput.value = getMsgId(ordered[1]);
          statusEl.textContent = "범위 저장 준비: " + startInput.value + " ~ " + endInput.value;
        }

        selectRows.forEach(function (row) {
          row.addEventListener("click", function () {
            var existingIdx = selectedRows.indexOf(row);
            if (existingIdx >= 0) {
              selectedRows.splice(existingIdx, 1);
              updateSelectionUI();
              return;
            }
            if (selectedRows.length >= 2) {
              selectedRows = [row];
              updateSelectionUI();
              return;
            }
            selectedRows.push(row);
            updateSelectionUI();
          });
        });

        var singleBtn = document.getElementById("bookmark-save-single");
        var rangeBtn = document.getElementById("bookmark-save-range");
        var clearBtn = document.getElementById("bookmark-clear-selection");

        if (singleBtn) {
          singleBtn.addEventListener("click", function () {
            if (!saveForm || !messageIdInput) return;
            if (!messageIdInput.value) {
              alert("단건 저장은 메시지 1개를 선택해 주세요.");
              return;
            }
            startInput.value = "";
            endInput.value = "";
            saveForm.submit();
          });
        }

        if (rangeBtn) {
          rangeBtn.addEventListener("click", function () {
            if (!saveForm || !startInput || !endInput) return;
            if (!startInput.value || !endInput.value) {
              alert("범위 저장은 메시지 2개를 선택해 주세요.");
              return;
            }
            messageIdInput.value = "";
            saveForm.submit();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener("click", function () {
            selectedRows = [];
            updateSelectionUI();
          });
        }

        updateSelectionUI();

        var chat = document.getElementById("chat-scroll");
        var targetMessageId = {{ bookmark_target_message_id | tojson }};
        if (targetMessageId) {
          var target = document.getElementById("msg-" + targetMessageId);
          if (target) {
            target.classList.add("msg-focus");
            target.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
        var searching = {{ 'true' if search_query else 'false' }};
        if (chat && !location.hash && !searching && !targetMessageId) {
          chat.scrollTop = chat.scrollHeight;
        }
      })();
    </script>
    {% include "_auth_guard.html" %}
  </body>
</html>
