<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>대화</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="chat-page">
    <header class="topbar">
      <div class="topbar-title">대화</div>
      <nav class="topbar-actions">
        <div class="nav-tabs">
          <a class="tab" href="{{ url_for('diary') }}">일기</a>
          <a class="tab is-active" href="{{ url_for('index', view='chat', q=search_query) }}">대화</a>
          <a class="tab" href="{{ url_for('todo') }}">함께할일</a>
          <a class="tab" href="{{ url_for('memories') }}">추억</a>
        </div>
        <div class="nav-links">
          <a class="link" href="{{ url_for('index', view='txt', q=search_query) }}">텍스트 형식</a>
          <a class="link" href="{{ url_for('admin_import') }}">가져오기</a>
          <a class="link" href="{{ url_for('admin_export') }}">내보내기</a>
          <a class="link" href="{{ url_for('logout') }}">로그아웃</a>
        </div>
      </nav>
      <div class="topbar-tools">
        <form class="search-form" method="get" action="{{ url_for('index') }}">
          <input type="hidden" name="view" value="chat" />
          <input class="search" type="search" name="q" placeholder="검색어" value="{{ search_query or '' }}" />
          <button class="btn btn-secondary" type="submit">검색</button>
          {% if search_query %}
            <a class="link" href="{{ url_for('index', view='chat') }}">전체</a>
          {% endif %}
        </form>
        <form class="me-form" method="post" action="{{ url_for('set_me') }}">
          <label class="me-label">오른쪽(나)</label>
          <select class="select" name="me_name" onchange="this.form.submit()">
            <option value="">(선택)</option>
            {% for s in senders or [] %}
              <option value="{{ s.sender }}" {% if me_name == s.sender %}selected{% endif %}>{{ s.sender }} ({{ s.count }})</option>
            {% endfor %}
          </select>
        </form>
        <form class="jump-date-form" method="get" action="{{ url_for('index') }}">
          <input type="hidden" name="view" value="chat" />
          <input type="hidden" name="q" value="{{ search_query or '' }}" />
          <label class="me-label" for="focus-date-input">날짜 이동</label>
          <input class="input jump-date-input" id="focus-date-input" type="date" name="date" value="{{ focus_date or '' }}" />
          <button class="btn btn-secondary" type="submit">이동</button>
        </form>
        <button class="btn btn-secondary chat-sidebar-open-btn" type="button" id="bookmark-sidebar-open">책갈피</button>
      </div>
    </header>

    {% with flashes = get_flashed_messages(with_categories=true) %}
      {% if flashes %}
        <div class="flash chat-flash">
          {% for category, message in flashes %}
            <div class="flash-item {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if search_query %}
      <div class="search-banner">“{{ search_query }}” 검색 결과: {{ search_count or 0 }}건</div>
    {% endif %}

    <div class="chat-main-wrap">
      <main class="chat" id="chat-scroll">
        {% for d in days or [] %}
          <section class="chat-day" data-date-key="{{ d.date_key }}">
            <div class="day-sep" id="day-{{ d.date_key }}">--------------- {{ d.date_ko }} ---------------</div>
            {% for m in d.messages %}
              {% set is_me = (me_name and m.sender == me_name) %}
              <div class="msg-row msg-selectable {{ 'me' if is_me else 'other' }}" id="msg-{{ m.id }}" data-msg-id="{{ m.id }}" data-msg-dt="{{ m.dt }}" data-date-key="{{ d.date_key }}">
                {% if is_me %}
                  <div class="time">{{ m.time_ko }}</div>
                  <div class="bubble bubble-me">{{ m.text_html }}</div>
                {% else %}
                  <div class="msg-col">
                    <div class="sender">{{ m.sender }}</div>
                    <div class="bubble bubble-other">{{ m.text_html }}</div>
                  </div>
                  <div class="time">{{ m.time_ko }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </section>
        {% endfor %}
      </main>

      <aside class="chat-sidebar" id="chat-sidebar">
        <div class="chat-sidebar-head-row">
          <div class="chat-sidebar-head">책갈피 {{ bookmarks|length }}개</div>
          <button class="btn btn-secondary chat-sidebar-close-btn" type="button" id="bookmark-sidebar-close">닫기</button>
        </div>
        <form id="bookmark-save-form" class="chat-bookmark-save-form chat-bookmark-save-form-side" method="post" action="{{ url_for('chat_bookmark_add') }}">
          <input type="hidden" name="view" value="chat" />
          <input type="hidden" name="q" value="{{ search_query or '' }}" />
          <input type="hidden" name="date" value="{{ focus_date or '' }}" />
          <input type="hidden" name="message_id" id="bookmark-message-id" />
          <input type="hidden" name="start_message_id" id="bookmark-start" />
          <input type="hidden" name="end_message_id" id="bookmark-end" />
          <button class="btn btn-secondary" type="button" id="bookmark-save-single">선택 1개 저장</button>
          <button class="btn btn-secondary" type="button" id="bookmark-save-range">선택 범위 저장</button>
          <button class="btn btn-secondary" type="button" id="bookmark-clear-selection">선택 해제</button>
        </form>
        <div class="chat-bookmark-status" id="bookmark-status" data-default="메시지를 클릭해서 1개(단건) 또는 2개(범위) 선택">
          메시지를 클릭해서 1개(단건) 또는 2개(범위) 선택
        </div>
        {% if loaded_start_date and loaded_end_date %}
          <div class="chat-bookmark-load-range" id="chat-load-range">현재 로딩 범위: {{ loaded_start_date }} ~ {{ loaded_end_date }}</div>
        {% endif %}
        {% if bookmarks %}
          <div class="chat-bookmark-list-vertical">
            {% for b in bookmarks %}
              <div class="chat-bookmark-item {% if bookmark_selected_id == b.id %}is-selected{% endif %}">
                <a class="chat-bookmark-link" href="{{ url_for('index', view='chat', q=search_query, bookmark=b.id) }}">{{ b.display_title }}</a>
                <div class="chat-bookmark-meta">{{ b.display_range }}</div>
                <form method="post" action="{{ url_for('chat_bookmark_delete', bookmark_id=b.id) }}">
                  <input type="hidden" name="view" value="chat" />
                  <input type="hidden" name="q" value="{{ search_query or '' }}" />
                  <input type="hidden" name="date" value="{{ focus_date or '' }}" />
                  <input type="hidden" name="bookmark" value="{{ bookmark_selected_id or '' }}" />
                  <button class="link-button" type="submit">삭제</button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="chat-bookmark-empty">저장된 책갈피가 없습니다.</div>
        {% endif %}
      </aside>
    </div>
    <div class="chat-sidebar-backdrop" id="bookmark-sidebar-backdrop"></div>

    <script>
      (function () {
        var chat = document.getElementById("chat-scroll");
        var saveForm = document.getElementById("bookmark-save-form");
        var messageIdInput = document.getElementById("bookmark-message-id");
        var startInput = document.getElementById("bookmark-start");
        var endInput = document.getElementById("bookmark-end");
        var statusEl = document.getElementById("bookmark-status");
        var loadRangeEl = document.getElementById("chat-load-range");
        var openSidebarBtn = document.getElementById("bookmark-sidebar-open");
        var closeSidebarBtn = document.getElementById("bookmark-sidebar-close");
        var sidebarBackdrop = document.getElementById("bookmark-sidebar-backdrop");
        var singleBtn = document.getElementById("bookmark-save-single");
        var rangeBtn = document.getElementById("bookmark-save-range");
        var clearBtn = document.getElementById("bookmark-clear-selection");

        var selectedRows = [];
        var searching = {{ 'true' if search_query else 'false' }};
        var meName = {{ (me_name or '') | tojson }};
        var chunkDays = Number({{ window_chunk_days | tojson }}) || 3;
        var chatWindowApi = {{ chat_window_api | tojson }};
        var loadedStartDate = {{ loaded_start_date | tojson }};
        var loadedEndDate = {{ loaded_end_date | tojson }};
        var oldestDate = {{ oldest_date | tojson }};
        var latestDate = {{ latest_date | tojson }};
        var loadingPrev = false;
        var loadingNext = false;
        var hasMorePrev = true;
        var hasMoreNext = true;

        function listSelectableRows() {
          if (!chat) return [];
          return Array.prototype.slice.call(chat.querySelectorAll(".msg-selectable"));
        }

        function getMsgId(row) {
          return String(row.getAttribute("data-msg-id") || "");
        }

        function getMsgDt(row) {
          return String(row.getAttribute("data-msg-dt") || "");
        }

        function compareRows(a, b) {
          var aDt = getMsgDt(a);
          var bDt = getMsgDt(b);
          if (aDt < bDt) return -1;
          if (aDt > bDt) return 1;
          return Number(getMsgId(a)) - Number(getMsgId(b));
        }

        function parseIsoDate(value) {
          var text = String(value || "");
          var parts = text.split("-");
          if (parts.length !== 3) return null;
          var y = Number(parts[0]);
          var m = Number(parts[1]) - 1;
          var d = Number(parts[2]);
          if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;
          return new Date(Date.UTC(y, m, d));
        }

        function formatIsoDate(dt) {
          if (!dt) return "";
          var y = dt.getUTCFullYear();
          var m = String(dt.getUTCMonth() + 1).padStart(2, "0");
          var d = String(dt.getUTCDate()).padStart(2, "0");
          return y + "-" + m + "-" + d;
        }

        function addDays(dateText, days) {
          var dt = parseIsoDate(dateText);
          if (!dt) return "";
          dt.setUTCDate(dt.getUTCDate() + days);
          return formatIsoDate(dt);
        }

        function compareDate(a, b) {
          if (!a || !b) return 0;
          if (a < b) return -1;
          if (a > b) return 1;
          return 0;
        }

        function escapeHtml(text) {
          return String(text || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function textToHtml(text) {
          return escapeHtml(text).replace(/\r\n/g, "\n").replace(/\r/g, "\n").replace(/\n/g, "<br>");
        }

        function updateLoadRangeText() {
          if (!loadRangeEl) return;
          if (loadedStartDate && loadedEndDate) {
            loadRangeEl.textContent = "현재 로딩 범위: " + loadedStartDate + " ~ " + loadedEndDate;
          }
        }

        function pruneDetachedSelection() {
          selectedRows = selectedRows.filter(function (row) {
            return Boolean(row && row.isConnected);
          });
        }

        function updateSelectionUI() {
          var rows = listSelectableRows();
          rows.forEach(function (row) {
            row.classList.remove("msg-selected");
            row.classList.remove("msg-selected-end");
          });
          pruneDetachedSelection();
          selectedRows.forEach(function (row, idx) {
            row.classList.add("msg-selected");
            if (idx === 1) row.classList.add("msg-selected-end");
          });

          if (!messageIdInput || !startInput || !endInput || !statusEl) return;
          messageIdInput.value = "";
          startInput.value = "";
          endInput.value = "";

          var prefix = statusEl.getAttribute("data-default") || "메시지를 클릭해서 1개(단건) 또는 2개(범위) 선택";
          if (selectedRows.length === 0) {
            statusEl.textContent = prefix;
            return;
          }
          if (selectedRows.length === 1) {
            messageIdInput.value = getMsgId(selectedRows[0]);
            statusEl.textContent = "단건 저장 준비: 메시지 " + messageIdInput.value;
            return;
          }
          var ordered = selectedRows.slice().sort(compareRows);
          startInput.value = getMsgId(ordered[0]);
          endInput.value = getMsgId(ordered[1]);
          statusEl.textContent = "범위 저장 준비: " + startInput.value + " ~ " + endInput.value;
        }

        if (chat) {
          chat.addEventListener("click", function (event) {
            var row = event.target.closest(".msg-selectable");
            if (!row || !chat.contains(row)) return;
            var existingIdx = selectedRows.indexOf(row);
            if (existingIdx >= 0) {
              selectedRows.splice(existingIdx, 1);
              updateSelectionUI();
              return;
            }
            if (selectedRows.length >= 2) {
              selectedRows = [row];
              updateSelectionUI();
              return;
            }
            selectedRows.push(row);
            updateSelectionUI();
          });
        }

        if (singleBtn) {
          singleBtn.addEventListener("click", function () {
            if (!saveForm || !messageIdInput) return;
            if (!messageIdInput.value) {
              alert("단건 저장은 메시지 1개를 선택해 주세요.");
              return;
            }
            startInput.value = "";
            endInput.value = "";
            saveForm.submit();
          });
        }

        if (rangeBtn) {
          rangeBtn.addEventListener("click", function () {
            if (!saveForm || !startInput || !endInput) return;
            if (!startInput.value || !endInput.value) {
              alert("범위 저장은 메시지 2개를 선택해 주세요.");
              return;
            }
            messageIdInput.value = "";
            saveForm.submit();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener("click", function () {
            selectedRows = [];
            updateSelectionUI();
          });
        }

        function setSidebarOpen(isOpen) {
          document.body.classList.toggle("bookmark-sidebar-open", Boolean(isOpen));
        }

        if (openSidebarBtn) {
          openSidebarBtn.addEventListener("click", function () {
            setSidebarOpen(true);
          });
        }
        if (closeSidebarBtn) {
          closeSidebarBtn.addEventListener("click", function () {
            setSidebarOpen(false);
          });
        }
        if (sidebarBackdrop) {
          sidebarBackdrop.addEventListener("click", function () {
            setSidebarOpen(false);
          });
        }
        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") setSidebarOpen(false);
        });

        function createMessageNode(message, dateKey) {
          var row = document.createElement("div");
          var isMe = Boolean(message.is_me || (meName && message.sender === meName));
          row.className = "msg-row msg-selectable " + (isMe ? "me" : "other");
          row.id = "msg-" + String(message.id);
          row.setAttribute("data-msg-id", String(message.id));
          row.setAttribute("data-msg-dt", String(message.dt || ""));
          row.setAttribute("data-date-key", String(dateKey || ""));

          if (isMe) {
            var meTime = document.createElement("div");
            meTime.className = "time";
            meTime.textContent = String(message.time_ko || "");
            var meBubble = document.createElement("div");
            meBubble.className = "bubble bubble-me";
            meBubble.innerHTML = textToHtml(message.text || "");
            row.appendChild(meTime);
            row.appendChild(meBubble);
            return row;
          }

          var msgCol = document.createElement("div");
          msgCol.className = "msg-col";
          var sender = document.createElement("div");
          sender.className = "sender";
          sender.textContent = String(message.sender || "");
          var bubble = document.createElement("div");
          bubble.className = "bubble bubble-other";
          bubble.innerHTML = textToHtml(message.text || "");
          msgCol.appendChild(sender);
          msgCol.appendChild(bubble);

          var otherTime = document.createElement("div");
          otherTime.className = "time";
          otherTime.textContent = String(message.time_ko || "");

          row.appendChild(msgCol);
          row.appendChild(otherTime);
          return row;
        }

        function createDaySection(day) {
          var section = document.createElement("section");
          section.className = "chat-day";
          section.setAttribute("data-date-key", String(day.date_key || ""));

          var sep = document.createElement("div");
          sep.className = "day-sep";
          sep.id = "day-" + String(day.date_key || "");
          sep.textContent = "--------------- " + String(day.date_ko || day.date_key || "") + " ---------------";
          section.appendChild(sep);

          var messages = Array.isArray(day.messages) ? day.messages : [];
          messages.forEach(function (message) {
            section.appendChild(createMessageNode(message, day.date_key || ""));
          });
          return section;
        }

        function prependDays(days) {
          if (!chat || !days || !days.length) return;
          var beforeHeight = chat.scrollHeight;
          var frag = document.createDocumentFragment();
          days.forEach(function (day) {
            frag.appendChild(createDaySection(day));
          });
          chat.insertBefore(frag, chat.firstChild);
          var delta = chat.scrollHeight - beforeHeight;
          chat.scrollTop += delta;
        }

        function appendDays(days) {
          if (!chat || !days || !days.length) return;
          var frag = document.createDocumentFragment();
          days.forEach(function (day) {
            frag.appendChild(createDaySection(day));
          });
          chat.appendChild(frag);
        }

        function refreshLoadedRangeFromDom() {
          if (!chat) return;
          var dayNodes = chat.querySelectorAll(".chat-day");
          if (!dayNodes.length) return;
          loadedStartDate = String(dayNodes[0].getAttribute("data-date-key") || loadedStartDate || "");
          loadedEndDate = String(dayNodes[dayNodes.length - 1].getAttribute("data-date-key") || loadedEndDate || "");
          updateLoadRangeText();
        }

        function getCenterDateKey() {
          if (!chat) return "";
          var rows = listSelectableRows();
          if (!rows.length) {
            var firstDay = chat.querySelector(".chat-day");
            return firstDay ? String(firstDay.getAttribute("data-date-key") || "") : "";
          }
          var midY = chat.getBoundingClientRect().top + chat.clientHeight / 2;
          var bestRow = rows[0];
          var bestDist = Infinity;
          rows.forEach(function (row) {
            var rect = row.getBoundingClientRect();
            var center = (rect.top + rect.bottom) / 2;
            var dist = Math.abs(center - midY);
            if (dist < bestDist) {
              bestDist = dist;
              bestRow = row;
            }
          });
          return String(bestRow.getAttribute("data-date-key") || "");
        }

        function pruneFarDays() {
          if (!chat || searching) return;
          var centerDate = getCenterDateKey();
          if (!centerDate) return;
          var keepStart = addDays(centerDate, -chunkDays);
          var keepEnd = addDays(centerDate, chunkDays);
          if (!keepStart || !keepEnd) return;

          var removedTopHeight = 0;
          Array.prototype.slice.call(chat.querySelectorAll(".chat-day")).forEach(function (dayNode) {
            var dayKey = String(dayNode.getAttribute("data-date-key") || "");
            if (!dayKey) return;
            if (compareDate(dayKey, keepStart) < 0) {
              removedTopHeight += dayNode.offsetHeight;
              dayNode.remove();
              return;
            }
            if (compareDate(dayKey, keepEnd) > 0) {
              dayNode.remove();
            }
          });

          if (removedTopHeight > 0) {
            chat.scrollTop = Math.max(0, chat.scrollTop - removedTopHeight);
          }
          refreshLoadedRangeFromDom();
          updateSelectionUI();
        }

        function fetchWindow(startDate, endDate) {
          var url = new URL(chatWindowApi, window.location.origin);
          url.searchParams.set("start_date", startDate);
          url.searchParams.set("end_date", endDate);
          return fetch(url.toString(), { credentials: "same-origin" }).then(function (response) {
            if (!response.ok) throw new Error("window fetch failed");
            return response.json();
          });
        }

        function loadPrevWindow() {
          if (!chat || searching || loadingPrev || !hasMorePrev || !loadedStartDate || !chatWindowApi) {
            return Promise.resolve();
          }
          var requestEnd = addDays(loadedStartDate, -1);
          var requestStart = addDays(requestEnd, -(chunkDays - 1));
          if (!requestStart || !requestEnd) return Promise.resolve();
          if (oldestDate && compareDate(requestEnd, oldestDate) < 0) {
            hasMorePrev = false;
            return Promise.resolve();
          }
          if (oldestDate && compareDate(requestStart, oldestDate) < 0) {
            requestStart = oldestDate;
          }
          if (compareDate(requestStart, requestEnd) > 0) {
            hasMorePrev = false;
            return Promise.resolve();
          }
          loadingPrev = true;
          return fetchWindow(requestStart, requestEnd)
            .then(function (payload) {
              var days = (payload && payload.ok && Array.isArray(payload.days)) ? payload.days : [];
              if (!days.length) {
                hasMorePrev = false;
                return;
              }
              prependDays(days);
              refreshLoadedRangeFromDom();
              pruneFarDays();
            })
            .catch(function () {
              hasMorePrev = true;
            })
            .finally(function () {
              loadingPrev = false;
            });
        }

        function loadNextWindow() {
          if (!chat || searching || loadingNext || !hasMoreNext || !loadedEndDate || !chatWindowApi) {
            return Promise.resolve();
          }
          var requestStart = addDays(loadedEndDate, 1);
          var requestEnd = addDays(requestStart, chunkDays - 1);
          if (!requestStart || !requestEnd) return Promise.resolve();
          if (latestDate && compareDate(requestStart, latestDate) > 0) {
            hasMoreNext = false;
            return Promise.resolve();
          }
          if (latestDate && compareDate(requestEnd, latestDate) > 0) {
            requestEnd = latestDate;
          }
          if (compareDate(requestStart, requestEnd) > 0) {
            hasMoreNext = false;
            return Promise.resolve();
          }
          loadingNext = true;
          return fetchWindow(requestStart, requestEnd)
            .then(function (payload) {
              var days = (payload && payload.ok && Array.isArray(payload.days)) ? payload.days : [];
              if (!days.length) {
                hasMoreNext = false;
                return;
              }
              appendDays(days);
              refreshLoadedRangeFromDom();
              pruneFarDays();
            })
            .catch(function () {
              hasMoreNext = true;
            })
            .finally(function () {
              loadingNext = false;
            });
        }

        function maybeLoadByScroll() {
          if (!chat || searching) return;
          var topGap = chat.scrollTop;
          var bottomGap = chat.scrollHeight - chat.clientHeight - chat.scrollTop;
          if (topGap < 260) {
            loadPrevWindow();
          }
          if (bottomGap < 260) {
            loadNextWindow();
          }
        }

        var scrollTicking = false;
        function scheduleScrollCheck() {
          if (scrollTicking) return;
          scrollTicking = true;
          window.requestAnimationFrame(function () {
            scrollTicking = false;
            maybeLoadByScroll();
          });
        }

        updateSelectionUI();
        updateLoadRangeText();

        var targetMessageId = {{ bookmark_target_message_id | tojson }};
        if (targetMessageId) {
          var target = document.getElementById("msg-" + targetMessageId);
          if (target) {
            target.classList.add("msg-focus");
            target.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }

        if (chat && !location.hash && !searching && !targetMessageId) {
          chat.scrollTop = chat.scrollHeight;
        }

        if (chat && !searching) {
          chat.addEventListener("scroll", scheduleScrollCheck);
          window.addEventListener("resize", scheduleScrollCheck);
          setTimeout(scheduleScrollCheck, 80);
        }
      })();
    </script>
    {% include "_auth_guard.html" %}
  </body>
</html>
