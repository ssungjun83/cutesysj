<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>일기</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="chat-page diary-page">
    <header class="topbar">
      <div class="topbar-title">일기</div>
      <nav class="topbar-actions">
        <div class="nav-tabs">
          <a class="tab is-active" href="{{ url_for('diary') }}">일기</a>
          <a class="tab" href="{{ url_for('index', view='chat') }}">대화</a>
          <a class="tab" href="{{ url_for('memories') }}">추억</a>
        </div>
        <div class="nav-links">
          <a class="link" href="{{ url_for('admin_import') }}">가져오기</a>
          <a class="link" href="{{ url_for('admin_export') }}">내보내기</a>
          <a class="link" href="{{ url_for('logout') }}">로그아웃</a>
        </div>
      </nav>
    </header>

    {% with flashes = get_flashed_messages(with_categories=true) %}
      {% if flashes %}
        <div class="flash chat-flash">
          {% for category, message in flashes %}
            <div class="flash-item {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if not drive_ready %}
      <div class="diary-alert">
        <strong>Drive 설정 필요:</strong> {{ drive_hint }}
      </div>
    {% endif %}

    <main class="diary">
      <section class="diary-editor">
        <div class="diary-editor-head">
          <h2 class="section-title">{{ "일기 수정" if editing else "오늘의 기록" }}</h2>
          {% if editing %}
            <span class="diary-editing">수정 중</span>
          {% endif %}
        </div>
        <form method="post" action="{{ url_for('diary_edit_post', entry_id=editing.id) if editing else url_for('diary_post') }}" enctype="multipart/form-data">
          <input type="hidden" name="q" value="{{ search_query or '' }}" />
          <input type="hidden" name="start_date" value="{{ start_date or '' }}" />
          <input type="hidden" name="end_date" value="{{ end_date or '' }}" />

          <label class="label">날짜</label>
          <input class="input" type="date" name="entry_date" value="{{ editing.entry_date_value if editing else today }}" />

          <label class="label">제목</label>
          <input class="input" type="text" name="title" placeholder="무제" value="{{ editing.title if editing else '' }}" />

          <label class="label">내용</label>
          <textarea class="textarea" name="body" rows="8" placeholder="오늘의 기록을 남겨보세요.">{{ editing.body if editing else '' }}</textarea>

          <label class="label">사진</label>
          <input id="diary-photo-input" class="input" type="file" name="photos" accept="image/*" multiple {% if not drive_ready %}disabled{% endif %} />
          <div id="diary-photo-help" class="diary-photo-help">Drive에 업로드됩니다. (붙여넣기: Ctrl+V)</div>

          <div class="diary-editor-actions">
            <button class="btn" type="submit">{{ "수정 저장" if editing else "저장" }}</button>
            {% if editing %}
              <a class="link" href="{{ url_for('diary', q=search_query, start_date=start_date, end_date=end_date) }}">수정 취소</a>
            {% endif %}
          </div>
        </form>
      </section>

      <section class="diary-controls">
        <form class="diary-filters" method="get" action="{{ url_for('diary') }}">
          <label class="label">키워드</label>
          <input class="input" type="search" name="q" placeholder="제목/내용 검색" value="{{ search_query or '' }}" />
          <label class="label">기간</label>
          <div class="diary-range">
            <input class="input" type="date" name="start_date" value="{{ start_date or '' }}" />
            <span class="range-sep">~</span>
            <input class="input" type="date" name="end_date" value="{{ end_date or '' }}" />
          </div>
          <div class="diary-filter-actions">
            <button class="btn btn-secondary" type="submit">필터 적용</button>
            {% if search_query or start_date or end_date %}
              <a class="link" href="{{ url_for('diary') }}">필터 초기화</a>
            {% endif %}
          </div>
        </form>
        <div class="diary-actions">
          <div class="diary-actions-title">내보내기</div>
          <div class="diary-actions-buttons">
            <a class="btn-link" href="{{ url_for('diary_export', format='txt', q=search_query, start_date=start_date, end_date=end_date) }}">TXT</a>
            <a class="btn-link" href="{{ url_for('diary_export', format='md', q=search_query, start_date=start_date, end_date=end_date) }}">MD</a>
            <a class="btn-link" href="{{ url_for('diary_export', format='csv', q=search_query, start_date=start_date, end_date=end_date) }}">CSV</a>
          </div>
        </div>
      </section>

      <section class="diary-list">
        <div class="diary-list-head">
          <h2 class="section-title">최근 일기</h2>
          <div class="diary-count">{{ entries|length }}건</div>
        </div>
        {% if entries %}
          {% for entry in entries %}
            <article class="diary-item">
              <div class="diary-meta">
                <div class="diary-date">{{ entry.date_ko }}{% if entry.time_ko %} / {{ entry.time_ko }}{% endif %}</div>
                <div class="diary-title">{{ entry.title }}</div>
              </div>
              <div class="diary-body">{{ entry.body_html }}</div>
              {% if entry.photos %}
                <div class="diary-photos">
                  {% for photo in entry.photos %}
                    <div class="diary-photo">
                      <img src="{{ url_for('diary_media', file_id=photo.drive_file_id) }}" alt="{{ photo.file_name }}" loading="lazy" decoding="async" />
                      <form class="diary-photo-actions" method="post" action="{{ url_for('diary_photo_delete', photo_id=photo.id) }}">
                        <input type="hidden" name="q" value="{{ search_query or '' }}" />
                        <input type="hidden" name="start_date" value="{{ start_date or '' }}" />
                        <input type="hidden" name="end_date" value="{{ end_date or '' }}" />
                        <button class="diary-photo-delete" type="submit" onclick="return confirm('이 사진을 삭제할까요?');">삭제</button>
                      </form>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="diary-comments">
                <div class="diary-comments-head">댓글 {{ entry.comments|length }}개</div>
                {% if entry.comments %}
                  <div class="diary-comment-list">
                    {% for comment in entry.comments %}
                      <div class="diary-comment">
                        <div class="diary-comment-meta">
                          <span class="diary-comment-date">{{ comment.created_at_display or comment.created_at }}</span>
                          <form method="post" action="{{ url_for('diary_comment_delete', comment_id=comment.id) }}">
                            <input type="hidden" name="entry_id" value="{{ entry.id }}" />
                            <input type="hidden" name="q" value="{{ search_query or '' }}" />
                            <input type="hidden" name="start_date" value="{{ start_date or '' }}" />
                            <input type="hidden" name="end_date" value="{{ end_date or '' }}" />
                            <button class="link-button" type="submit" onclick="return confirm('이 댓글을 삭제할까요?');">삭제</button>
                          </form>
                        </div>
                        <div class="diary-comment-body">{{ comment.body_html }}</div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="diary-comments-empty">아직 댓글이 없습니다.</div>
                {% endif %}
                <form class="diary-comment-form" method="post" action="{{ url_for('diary_comment_post', entry_id=entry.id) }}">
                  <input type="hidden" name="q" value="{{ search_query or '' }}" />
                  <input type="hidden" name="start_date" value="{{ start_date or '' }}" />
                  <input type="hidden" name="end_date" value="{{ end_date or '' }}" />
                  <label class="label">댓글</label>
                  <textarea class="textarea" name="comment_body" rows="3" placeholder="댓글을 남겨주세요."></textarea>
                  <button class="btn btn-secondary" type="submit">댓글 달기</button>
                </form>
              </div>
              <div class="diary-item-actions">
                <a class="link" href="{{ url_for('diary', edit=entry.id, q=search_query, start_date=start_date, end_date=end_date) }}">수정</a>
                <form method="post" action="{{ url_for('diary_delete_post', entry_id=entry.id) }}">
                  <input type="hidden" name="q" value="{{ search_query or '' }}" />
                  <input type="hidden" name="start_date" value="{{ start_date or '' }}" />
                  <input type="hidden" name="end_date" value="{{ end_date or '' }}" />
                  <button class="link-button" type="submit" onclick="return confirm('이 일기를 삭제할까요?');">삭제</button>
                </form>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <div class="diary-empty">아직 일기가 없습니다.</div>
        {% endif %}
      </section>
    </main>
    {% include "_auth_guard.html" %}
    <script>
      (function () {
        const input = document.getElementById("diary-photo-input");
        const help = document.getElementById("diary-photo-help");
        const editorForm = document.querySelector(".diary-editor form");
        if (!input || !editorForm || input.disabled) {
          return;
        }
        if (help) {
          help.dataset.defaultText = help.textContent || "";
        }

        const updateHelp = () => {
          if (!help) {
            return;
          }
          const count = input.files ? input.files.length : 0;
          if (!count) {
            help.textContent = help.dataset.defaultText || help.textContent;
            return;
          }
          help.textContent = `사진 ${count}장 선택됨. (붙여넣기: Ctrl+V)`;
        };

        const appendFiles = (files) => {
          if (!files.length) {
            return;
          }
          const dt = new DataTransfer();
          if (input.files) {
            Array.from(input.files).forEach((file) => dt.items.add(file));
          }
          files.forEach((file) => dt.items.add(file));
          input.files = dt.files;
          updateHelp();
        };

        input.addEventListener("change", updateHelp);
        editorForm.addEventListener("paste", (event) => {
          if (!event.clipboardData || input.disabled) {
            return;
          }
          const items = Array.from(event.clipboardData.items || []);
          const images = [];
          for (const item of items) {
            if (item.kind !== "file") {
              continue;
            }
            const file = item.getAsFile();
            if (file && file.type.startsWith("image/")) {
              images.push(file);
            }
          }
          if (images.length) {
            appendFiles(images);
          }
        });
      })();
    </script>
  </body>
</html>
