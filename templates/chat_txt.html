<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>대화 (텍스트)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="chat-page">
    <header class="topbar">
      <div class="topbar-title">대화 (텍스트)</div>
      <nav class="topbar-actions">
        <div class="nav-tabs">
          <a class="tab" href="{{ url_for('diary') }}">일기</a>
          <a class="tab is-active" href="{{ url_for('index', view='chat', q=search_query) }}">대화</a>
          <a class="tab" href="{{ url_for('todo') }}">함께할일</a>
          <a class="tab" href="{{ url_for('memories') }}">추억</a>
        </div>
        <div class="nav-links">
          <a class="link" href="{{ url_for('index', view='chat', q=search_query) }}">대화형</a>
          <a class="link" href="{{ url_for('admin_import') }}">가져오기</a>
          <a class="link" href="{{ url_for('admin_export') }}">내보내기</a>
          <a class="link" href="{{ url_for('logout') }}">로그아웃</a>
        </div>
      </nav>
      <div class="topbar-tools">
        <form class="search-form" method="get" action="{{ url_for('index') }}">
          <input type="hidden" name="view" value="txt" />
          <input class="search" type="search" name="q" placeholder="검색어" value="{{ search_query or '' }}" />
          <button class="btn btn-secondary" type="submit">검색</button>
          {% if search_query %}
            <a class="link" href="{{ url_for('index', view='txt') }}">전체</a>
          {% endif %}
        </form>
        <div class="jump">
          <form class="jump-date-form" method="get" action="{{ url_for('index') }}">
            <input type="hidden" name="view" value="txt" />
            <input type="hidden" name="q" value="{{ search_query or '' }}" />
            <label class="me-label" for="focus-date-input-txt">날짜 이동</label>
            <input class="input jump-date-input" id="focus-date-input-txt" type="date" name="date" value="{{ focus_date or '' }}" />
            <button class="btn btn-secondary" type="submit">이동</button>
          </form>
        </div>
      </div>
    </header>

    {% with flashes = get_flashed_messages(with_categories=true) %}
      {% if flashes %}
        <div class="flash chat-flash">
          {% for category, message in flashes %}
            <div class="flash-item {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if search_query %}
      <div class="search-banner">“{{ search_query }}” 검색 결과: {{ search_count or 0 }}건</div>
    {% endif %}

    <main class="chat" id="chat-scroll">
      <div class="txt-log">
        {% for d in days or [] %}
          <div class="day-sep" id="day-{{ d.date_key }}">--------------- {{ d.date_ko }} ---------------</div>
          {% for m in d.messages %}
            <div class="txt-row" id="msg-{{ m.id }}">[{{ m.sender }}] [{{ m.time_ko }}] {{ m.text_html }}</div>
          {% endfor %}
        {% endfor %}
      </div>
    </main>

    <script>
      (function () {
        var chat = document.getElementById("chat-scroll");
        var targetMessageId = {{ bookmark_target_message_id | tojson }};
        if (targetMessageId) {
          var target = document.getElementById("msg-" + targetMessageId);
          if (target) {
            target.classList.add("msg-focus");
            target.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
        if (chat && !location.hash && !targetMessageId) {
          chat.scrollTop = chat.scrollHeight;
        }
      })();
    </script>
    {% include "_auth_guard.html" %}
  </body>
</html>
